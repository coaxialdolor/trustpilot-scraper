<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Scrape Reviews</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Collect Reviews</h1>
      <a href="/landing" class="button-like">Back</a>
    </div>
    <form id="scrape-form" method="post" action="/scrape/run" onsubmit="return startScrapeSubmit(event)">
      <label>Company URL (Trustpilot)</label>
      <input type="text" name="company_url" value="https://www.trustpilot.com/review/www.europcar.co.uk?stars=1" placeholder="https://www.trustpilot.com/review/example.com" required />

      <label>Time/Page criteria</label>
      <select name="mode">
        <option value="pages">Pages</option>
        <option value="months">Months back</option>
        <option value="keywords">Keywords</option>
        <option value="dates">Date interval</option>
      </select>

      <label>Max pages (for Pages mode)</label>
      <input type="text" name="max_pages" placeholder="e.g. 10" />

      <label>Months back (for Months mode)</label>
      <input type="text" name="months" placeholder="e.g. 6" />

      <div id="kw-section">
        <label><input type="checkbox" id="kw-toggle" checked /> Filter by keywords</label>
        <div id="kw-fields">
          <label>Keywords (comma separated)</label>
          <input type="text" name="keywords" placeholder="e.g. charge, fee, insurance or +extra AND service" />
          <div class="help">Case-insensitive. Use +word or AND to require a term; commas mean OR.</div>
        </div>
      </div>

      <div id="date-range" style="display:none;">
        <label>Start date (for Date interval mode)</label>
        <input type="date" name="start_date" />
        <label>End date (for Date interval mode)</label>
        <input type="date" name="end_date" />
      </div>

      <fieldset>
        <legend>Resume previous run?</legend>
        <label><input type="radio" name="resume" value="no" checked /> No</label>
        <label><input type="radio" name="resume" value="yes" /> Yes</label>
      </fieldset>

      <div id="resume-options" style="display:none;">
        <label>Suggested previous runs</label>
        <select name="resume_suggested" id="resume_suggested">
          <option value="">-- select a previous run --</option>
        </select>
        <label>Or choose a file (.json) from your computer</label>
        <input type="file" name="resume_file" accept=".json" />
      </div>

      <div class="menubar">
        <button type="submit" onclick="startScrape(this)">Start Scrape</button>
        <button type="button" onclick="stopScrape()" class="danger">Stop</button>
        <a href="/" class="button-like">Go to Sort/Analyze</a>
      </div>
    </form>

    <div id="progress" class="progress hidden">
      <div class="progress-bar"></div>
      <div class="progress-text">Scraping… This may take a while on first run.</div>
    </div>

    <div id="scrape-log" class="card" style="display:none;">
      <div class="reviewer">Live progress</div>
      <pre id="log-text" class="text" style="height: 12em; overflow:auto; margin:0;"></pre>
      <div class="menubar" style="margin-top:10px; display:none;" id="dlbar">
        <a class="btn" href="/scrape/download_last">Download last results (ZIP)</a>
      </div>
    </div>
  </div>
  <script>
    async function startScrapeSubmit(ev){
      ev.preventDefault();
      const btn = ev.target.querySelector('button[type="submit"]');
      try { btn.disabled = true; btn.textContent = 'Starting…'; } catch(e){}
      const p = document.getElementById('progress');
      if(p){ p.classList.remove('hidden'); }
      const form = document.getElementById('scrape-form');
      const fd = new FormData(form);
      try {
        const res = await fetch('/scrape/run', { method: 'POST', body: fd });
        const js = await res.json().catch(()=>({}));
        // Start log streaming regardless; backend returns quickly
        streamLogs();
      } catch(err) {
        // Still try to stream in case it started
        streamLogs();
      }
      return false;
    }

    function streamLogs(){
      const logBox = document.getElementById('scrape-log');
      const pre = document.getElementById('log-text');
      logBox.style.display = 'block';
      const evt = new EventSource('/scrape/stream');
      evt.onmessage = (e)=>{
        try{
          const data = JSON.parse(e.data);
          if(data.line){
            pre.textContent += (pre.textContent ? "\n" : "") + data.line;
            pre.scrollTop = pre.scrollHeight;
            if(data.line === '[DONE]'){
              evt.close();
              const p = document.getElementById('progress');
              if(p){ p.classList.add('hidden'); }
              const btn = document.querySelector('#scrape-form button[type="submit"]');
              if(btn){ btn.disabled = false; btn.textContent = 'Start Scrape'; }
              const dlbar = document.getElementById('dlbar');
              if(dlbar){ dlbar.style.display = 'flex'; }
            }
          }
        }catch(err){}
      };
      evt.onerror = ()=>{ evt.close(); };
    }

    function stopScrape(){
      fetch('/scrape/stop', {method:'POST'});
    }

    // Dynamic UI behavior
    const modeEl = document.querySelector('select[name="mode"]');
    const dateRange = document.getElementById('date-range');
    function updateModeFields(){
      dateRange.style.display = modeEl.value === 'dates' ? 'block' : 'none';
    }
    modeEl.addEventListener('change', updateModeFields);
    updateModeFields();

    // Keywords toggle
    const kwToggle = document.getElementById('kw-toggle');
    const kwFields = document.getElementById('kw-fields');
    function updateKw(){ kwFields.style.display = kwToggle.checked ? 'block' : 'none'; }
    kwToggle.addEventListener('change', updateKw);
    updateKw();

    // Resume radio toggle and fetch suggestions
    const resumeRadios = document.querySelectorAll('input[name="resume"]');
    const resumeBox = document.getElementById('resume-options');
    function updateResume(){
      const val = document.querySelector('input[name="resume"]:checked').value;
      if(val === 'yes'){
        resumeBox.style.display = 'block';
        // Load suggestions
        fetch('/scrape/suggestions').then(r=>r.json()).then(js=>{
          const sel = document.getElementById('resume_suggested');
          sel.innerHTML = '<option value="">-- select a previous run --</option>';
          (js.files||[]).forEach(p=>{
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            sel.appendChild(opt);
          });
        }).catch(()=>{});
      } else {
        resumeBox.style.display = 'none';
      }
    }
    resumeRadios.forEach(r=>r.addEventListener('change', updateResume));
    updateResume();
  </script>
</body>
</html>

