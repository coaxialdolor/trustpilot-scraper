<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Scrape Reviews</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Collect Reviews</h1>
      <a href="/landing" class="button-like">Back</a>
    </div>
    <form id="scrape-form" method="post" action="/scrape/run" onsubmit="return startScrapeSubmit(event)">
      <label>Company URL (Trustpilot)</label>
      <input type="text" name="company_url" value="https://www.trustpilot.com/review/www.europcar.co.uk?stars=1" placeholder="https://www.trustpilot.com/review/example.com" required />

      <label>Mode</label>
      <select name="mode">
        <option value="pages">Pages</option>
        <option value="months">Months back</option>
        <option value="keywords">Keywords</option>
      </select>

      <label>Max pages (for Pages mode)</label>
      <input type="text" name="max_pages" placeholder="e.g. 10" />

      <label>Months back (for Months mode)</label>
      <input type="text" name="months" placeholder="e.g. 6" />

      <label>Keywords (comma separated, for Keywords mode)</label>
      <input type="text" name="keywords" placeholder="charge, fee, insurance" />

      <label>Resume previous run?</label>
      <select name="resume">
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>

      <div class="menubar">
        <button type="submit" onclick="startScrape(this)">Start Scrape</button>
        <button type="button" onclick="stopScrape()" class="danger">Stop</button>
        <a href="/" class="button-like">Go to Sort/Analyze</a>
      </div>
    </form>

    <div id="progress" class="progress hidden">
      <div class="progress-bar"></div>
      <div class="progress-text">Scraping… This may take a while on first run.</div>
    </div>

    <div id="scrape-log" class="card" style="display:none;">
      <div class="reviewer">Live progress</div>
      <pre id="log-text" class="text" style="height: 12em; overflow:auto; margin:0;"></pre>
    </div>
  </div>
  <script>
    async function startScrapeSubmit(ev){
      ev.preventDefault();
      const btn = ev.target.querySelector('button[type="submit"]');
      try { btn.disabled = true; btn.textContent = 'Starting…'; } catch(e){}
      const p = document.getElementById('progress');
      if(p){ p.classList.remove('hidden'); }
      const form = document.getElementById('scrape-form');
      const fd = new FormData(form);
      try {
        const res = await fetch('/scrape/run', { method: 'POST', body: fd });
        const js = await res.json().catch(()=>({}));
        // Start log streaming regardless; backend returns quickly
        streamLogs();
      } catch(err) {
        // Still try to stream in case it started
        streamLogs();
      }
      return false;
    }

    function streamLogs(){
      const logBox = document.getElementById('scrape-log');
      const pre = document.getElementById('log-text');
      logBox.style.display = 'block';
      const evt = new EventSource('/scrape/stream');
      evt.onmessage = (e)=>{
        try{
          const data = JSON.parse(e.data);
          if(data.line){
            pre.textContent += (pre.textContent ? "\n" : "") + data.line;
            pre.scrollTop = pre.scrollHeight;
            if(data.line === '[DONE]'){
              evt.close();
              const p = document.getElementById('progress');
              if(p){ p.classList.add('hidden'); }
              const btn = document.querySelector('#scrape-form button[type="submit"]');
              if(btn){ btn.disabled = false; btn.textContent = 'Start Scrape'; }
            }
          }
        }catch(err){}
      };
      evt.onerror = ()=>{ evt.close(); };
    }

    function stopScrape(){
      fetch('/scrape/stop', {method:'POST'});
    }
  </script>
</body>
</html>

